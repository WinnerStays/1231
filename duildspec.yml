version: 0.2

phases:
    install:
        runtime-versions:
            nodejs: 16
    pre_build:
        commands:
         - aws ecr get-login-password --region ap-northeast-1 | docker login --username AWS --password-stdin 180294177797.dkr.ecr.ap-northeast-1.amazonaws.com
    build:
        commands:
        - echo Bulid started on `date`
        - npm install
        - echo npm install build completed on `date`
        - npm run build
        - echo npm run build completed on `date`
        - TAG="date +'%Y%m%d%H%M%S'"
        - docker build -t 180294177797.dkr.ecr.ap-northeast-1.amazonaws.com/ecr-nginx1231:$TAG ./
        - echo docker build completed on `date`
        - docker push 180294177797.dkr.ecr.ap-northeast-1.amazonaws.com/ecr-nginx1231:$TAG
        - echo docker push completed on `date`
    post_build:
        commands:
        - echo "Build completed on `date`"
        - printf '[{"name":"mynginx","imageUri":"180294177797.dkr.ecr.ap-northeast-1.amazonaws.com/ecr-nginx1231:%s"}]' $TAG > imagedefinitions.json
        - cat imagedefinitions.json

artifacts:
    files:
      - imagedefinitions.json
